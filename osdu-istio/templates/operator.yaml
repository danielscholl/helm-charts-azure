{{- $serviceAnnotations := include "istio.gateway.annotations" (dict "Release" .Release "Values" .Values) }}
apiVersion: install.istio.io/v1alpha1
kind: IstioOperator
metadata:
  namespace: {{ .Release.Namespace }}
  name: istio-osdu
spec:
  hub: msosdu.azurecr.io/istio
  tag: 1.15.2
  meshConfig:
    defaultConfig:
      extraStatTags:
        - request_method
        - request_path
      proxyStatsMatcher:
        inclusionRegexps:
        - .*upstream_rq_retry.*osdu.*
        - .*upstream_rq_retry_success.*osdu.*
        - .*upstream_rq_retry_overflow.*osdu.*
        - .*ejections_detected_consecutive_5xx.*osdu.*
        - .*ejections_enforced_total.*osdu.*
  profile: default
  values:
    global:
      proxy:
        logLevel: info
    gateways:
      istio-ingressgateway:
        serviceAnnotations: 
          {{- $serviceAnnotations | indent 10 }}
        loadBalancerIP: "{{ .Values.global.istio.loadBalancerIP }}"
    telemetry:
      v2:
        prometheus:
          configOverride:
            inboundSidecar:
              metrics:
                - name: requests_total
                  dimensions:
                    request_method: request.method
                    request_path: response.headers['x-internal-uri-pattern']
                - name: request_duration_milliseconds
                  dimensions:
                    request_method: request.method
                    request_path: response.headers['x-internal-uri-pattern']
            outboundSidecar:
              metrics:
                - name: requests_total
                  dimensions:
                    request_method: request.method
                    request_path: response.headers['x-internal-uri-pattern']
                - name: request_duration_milliseconds
                  dimensions:
                    request_method: request.method
                    request_path: response.headers['x-internal-uri-pattern']
            gateway:
              metrics:
                - name: requests_total
                  dimensions:
                    request_method: request.method
                    request_path: response.headers['x-internal-uri-pattern']
                - name: request_duration_milliseconds
                  dimensions:
                    request_method: request.method
                    request_path: response.headers['x-internal-uri-pattern']
  components:
    pilot:
      k8s:
        replicaCount: 2
        hpaSpec:
          minReplicas: 2
    ingressGateways:
    - name: istio-ingressgateway
      enabled: true
      k8s:
        replicaCount: 2
        resources:
          requests:
            cpu: 350m
            memory: 1G
          limits:
            cpu: "1"
            memory: 2G
        hpaSpec:
          minReplicas: 2
          maxReplicas: 10
          metrics:
          - type: Resource
            resource:
              name: cpu
              target:
                type: Utilization
                averageUtilization: 70
          # https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/#default-behavior
